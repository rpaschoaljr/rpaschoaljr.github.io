<!DOCTYPE html>
<html>

<head>
    <title>Leitor de Código de Barras</title>
    <style>
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        video {
            width: 320px;
            height: 240px;
            border: 2px solid #ccc;
        }

        #barcode-value {
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #ccc;
        }

        .barcode-highlight {
            position: absolute;
            border: 2px solid red;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Leitor de Código de Barras</h1>
        <video id="video" autoplay></video>
        <input type="text" id="barcode-value" placeholder="Valor do Código de Barras">
        <canvas id="canvas" width="320" height="240"></canvas>
    </div>

    <!-- Bibliotecas Externas -->
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>

    <script>
        const video = document.getElementById('video');
        const barcodeValue = document.getElementById('barcode-value');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Verificação de compatibilidade com ZXing
        if (typeof ZXing === 'undefined') {
            barcodeValue.value = "ZXing não está disponível. Verifique se a biblioteca foi carregada corretamente.";
        } else {
            let codeReader;
            let animationId;

            async function startBarcodeDetection() {
                try {
                    codeReader = new ZXing.BrowserMultiFormatReader();
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    video.srcObject = stream;

                    video.onloadedmetadata = () => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        requestAnimationFrame(decodeBarcode);
                    };
                } catch (err) {
                    console.error('Erro ao acessar a câmera:', err);
                    barcodeValue.value = "Permissão de acesso à câmera negada.";
                }
            }

            function decodeBarcode() {
                if (!codeReader) return;

                codeReader.decodeFromVideoElement(video, canvas)
                    .then(result => {
                        if (result) {
                            barcodeValue.value = result.text;
                            drawResultPoints(result);
                        } else {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                        }
                    })
                    .catch(err => {
                        console.error('Erro na leitura do código de barras:', err);
                    })
                    .finally(() => {
                        animationId = requestAnimationFrame(decodeBarcode);
                    });
            }

            function drawResultPoints(result) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;
                for (let i = 0; i < result.resultPoints.length; i++) {
                    const point = result.resultPoints[i];
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, 5, 0, 2 * Math.PI);
                    ctx.stroke();
                }
            }

            startBarcodeDetection();
        }

    </script>
</body>

</html>
