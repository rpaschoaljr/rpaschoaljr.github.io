<!DOCTYPE html>
<html>

<head>
    <title>Leitor de Código de Barras</title>
</head>

<body>
    <div class="container">
        <h1>Leitor de Código de Barras</h1>
        <video id="video" autoplay></video>
        <input type="text" id="barcode-value" placeholder="Valor do Código de Barras">
    </div>

    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>

    <script>
        const video = document.getElementById('video');
        const barcodeValue = document.getElementById('barcode-value');
        let codeReader;
        let isDetecting = false; // Flag para controlar a detecção

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(stream => {
                video.srcObject = stream;
                codeReader = new ZXing.BrowserMultiFormatReader();
                startDetection(); // Inicia a detecção quando o vídeo estiver pronto
            })
            .catch(err => handleCameraError(err));

        async function startDetection() {
            if (isDetecting) return; // Impede múltiplas detecções simultâneas
            isDetecting = true;

            try {
                const result = await codeReader.decodeFromVideoDevice(null, 'video');
                if (result) {
                    barcodeValue.value = result.text;
                    stopDetection(); // Para a detecção após um resultado válido
                }
            } catch (err) {
                if (!(err instanceof ZXing.NotFoundException)) {
                    console.error('Erro na detecção:', err);
                    barcodeValue.value = "Erro na leitura";
                }
            } finally {
                isDetecting = false;
                setTimeout(startDetection, 500); // Reinicia a detecção após um intervalo (ajuste conforme necessário)
            }
        }

        function stopDetection() {
            codeReader.reset(); // Limpa o leitor para evitar detecções indesejadas
            isDetecting = false;
        }

        function handleCameraError(err) {
            console.error('Erro ao acessar a câmera:', err);
            if (err.name === 'NotAllowedError') {
                barcodeValue.value = "Permissão negada para câmera.";
            } else {
                barcodeValue.value = "Erro ao acessar a câmera.";
            }
        }
    </script>
</body>

</html>
